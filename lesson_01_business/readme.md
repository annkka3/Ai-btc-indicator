# AI Индикатор рынка BTC — Бизнес-анализ (MVP)

## 1. Цели и формулировка задачи

### 1.1. Цель проекта

Построить **AI-индикатор** для прогноза движения **Bitcoin** на горизонтах **1ч, 4ч, 24ч** и формирования **объяснимого отчёта** в Telegram с ключевыми метриками и визуализациями.

### 1.2. Проблема

Розничным трейдерам и аналитикам не хватает объяснимого и оперативного прогноза BTC «на ближайшие часы» в удобном формате Telegram-бота.

### 1.3. Ценность

**Для пользователя:**
- Консистентные прогнозы на 1ч/4ч/24ч
- Единый отчёт-карточка с ключевыми метриками (волатильность, позиционирование, уровни риска/тренда)
- Доступ к использованным признакам (feature dump) и графикам
- Объяснимые прогнозы отклонения от тренда

**Для команды:**
- Учебная витрина MLOps и чистой архитектуры
- Площадка для исследований и расширений (альткоины, другие рынки, новые источники данных)
- Отработка практик разработки ML-сервисов

### 1.4. Бизнес-цель

Дать воспроизводимый и объяснимый **прогноз по BTC/USDT** на горизонтах **1ч, 4ч, 24ч**, дополняя его отчётом по факторам риска и режиму рынка, чтобы повысить полезность бота и подготовить монетизацию (подписка).

### 1.5. ML-формулировка (две связанные подзадачи)

**1. Регрессия «отклонения от тренда» (residual):**
\[
y_H(t) = \log P_{t+H} - \log \mathrm{MA}_L(t)
\]
где \(\mathrm{MA}_L\) — EMA/KAMA, рассчитанная **строго до \(t\)** (без утечек).

**2. Классификация направления:**
\[
d_H(t) = \mathbb{1}[y_H(t) > 0]
\]

**Вывод для каждого горизонта H:**
- Точечный прогноз \(\hat y_H\), квантильные интервалы (0.1/0.5/0.9) и вероятность направления \(\hat p = P(y_H > 0)\)
- «Режим рынка» (волатильность/тренд/ликвидность) для контекста решения

**Обоснование подхода:**
- Использование логарифмического отклонения от MA более стабильно и математически обосновано
- MA является естественным бейзлайном, отражающим тренд рынка
- Уменьшает влияние долгосрочных трендов и фокусируется на краткосрочных движениях
- Лучше поддается моделированию и интерпретации

---

## 2. Текущая ситуация (целевой контур MVP)

### 2.1. Технический контур

**Компоненты:**
- API-слой (FastAPI, webhook/health)
- Worker Telegram (python-telegram-bot)
- Сборщики данных
- Модуль визуализации (headless matplotlib)

**Хранилище:**
- Файлы/БД для OHLCV и агрегатов
- Слои: «сырые данные» → «фичи/лейблы» → «метрики/отчёты»
- SQLite (WAL) для исторических данных

**Интеграции (MVP):**
- Спот/перпы (через биржи/агрегаторы)
- Базовые макро-ряды (DXY)
- Опционально — ETF-потоки для 24ч

**Функции отчёта:**
- Прогнозы 1ч/4ч/24ч
- Режим рынка
- Базовые уровни/моментум
- «Пузыри»/топ-движения
- Краткий дайджест

### 2.2. Данные и целевые переменные

**Источники:**
- OHLCV BTCUSDT (и служебно — ETH, TOTAL2/3, BTC.D, USDT.D)
- Перпетуалы (funding, basis, OI, ликвидации)
- DXY
- Для 24ч — дневные ETF-потоки (при наличии)

**Фичи (ядро MVP, ~10):**
1. \(z\)-score цены к \(\mathrm{MA}_L\)
2. Realized vol \(\sigma_{20}\)
3. ATR% (14)
4. RSI(14) (+ «RSI>50»)
5. Нормированный моментум (MACD-hist/ATR)
6. Funding/basis z-score
7. \(\Delta OI\%\) (норм. на объём)
8. Интенсивность ликвидаций (6–24ч)
9. Для 24ч — DXY \(\Delta 1d\) **или** ETF net-flow (t-1)
10. Исторические отклонения от MA (лаги 1–6 периодов)

**Таргеты:**
- Регрессия: \(y_H(t)\) (residual — логарифмическое отклонение от MA)
- Классификация: \(d_H(t)\) (направление: выше/ниже MA)

### 2.3. Ресурсы и доступы

**Вычисления:**
- Контейнеры Docker на CPU
- GPU не требуется

**Доступы:**
- API-ключи провайдеров
- Лимиты запросов
- Конфигурация TZ/квот в `.env`

**Надёжность:**
- Ретраи, exponential backoff
- Circuit-breaker
- Кэширование данных

### 2.4. Ограничения/правовые аспекты

- **Нестационарность**: Смена режимов рынка (data drift)
- **Telegram rate limits**: Частота рассылок ограничена
- **Дисклеймеры**: Не персональные рекомендации; хранение секретов/логов
- **Финансовые риски**: Криптовалютный рынок высоковолатилен

### 2.5. Риски и меры снижения

| Риск | Проявление | Влияние | Митигирующие меры |
|------|------------|---------|-------------------|
| **Non-stationarity** | Падение качества онлайн | Высокое | Walk-forward/rolling, регулярное переобучение, мониторинг дрейфа, режимные гейты |
| **Утечки (look-ahead)** | Завышенные offline-метрики | Высокое | Purged/embargoed CV, строгие лаги, «срез по доступности», MA считается только по данным ≤ t |
| **Пропуски/качество** | Разрывы/аномалии | Среднее | Импутации, фильтры качества, резервные провайдеры, sanity-чекеры |
| **Латентность T_avail** | Запоздание ломает отчёты | Среднее | Карта источников с p50/p90-лагами, деградация к без-фичевому режиму |
| **API-квоты/изменения** | Ошибки сборки/инференса | Среднее | Адаптеры, circuit-breaker, кэш/пуллинг, алерты |
| **Ожидания пользователей** | Негатив/отток | Среднее | Ясные метрики и «правила игры», калибровка вероятностей, дисклеймеры |
| **Комплаенс** | Претензии к контенту | Среднее | Дисклеймеры, секреты в vault, аудит логов |

### 2.6. Операционные SLO (для сервиса)

- **Доступность прогнозов**: ≥ **99%** закрытых баров сопровождаются отчётом
- **Свежесть**: прогноз готов ≤ **30 с** после close (1ч/4ч), ≤ **2 мин** (24ч)
- **Латентность**: p95 инференса ≤ **2 с**; p95 доставки в Telegram ≤ **5 с** после close
- **Интеграции**: ≤ **1%** 4xx/5xx/timeout в сутки; ретраи+backoff включены
- **Версионирование**: в отчёте — версия модели, хэш данных/фич, timestamp генерации

### 2.7. Карта источников и задержек доступности (черновик v0)

| Источник | Сигналы | Частота | Типичный T_avail | SLA/примечание |
|----------|---------|---------|------------------|----------------|
| **Биржи (spot/perp)** | OHLCV, OI, funding | мин/час | секунды–минуты | основной фид; фолбэк — агрегатор |
| **Опционы (агрегатор)** | базово: нет в MVP | — | — | опционный блок — в backlog v2 |
| **CoinGlass/аналоги** | Ликвидации, OI-сводки | мин/час | 1–10 мин | квоты/rate-limit |
| **Ончейн-агрегатор** | базово: нет в MVP | — | — | ончейн — в backlog v2 |
| **ETF-потоки** | Притоки/оттоки, AUM | день | 12–36 ч | использовать только для 24ч |
| **Макро (DXY)** | Индекс доллара | 1ч/1д | 15–60 мин | события (CPI/FOMC) флажить |

---

## 3. Метрики оценки и критерии успешности (сфокусированные)

### 3.1. Бейзлайны (обязательно)

1. **Persistence**: \(\hat y_H = 0\), \(\hat p = 0.5\) (нулевой прогноз)
2. **Seasonality**: частотная модель «час-в-неделе» (сезонность)
3. **Rule-based**: знак EMA-кросса/последней доходности (правила на основе индикаторов)

### 3.2. Регрессия (таргет \(y_H\))

**Метрики:**
- **MAE(\(y_H\))** в базисных пунктах (б.п.)
- **База**: нулевой прогноз (Persistence)
- **Критерий успеха**: снижение MAE vs базы:
  - **1ч ≥ 5%**
  - **4ч ≥ 6%**
  - **24ч ≥ 8%**

**Диагностика:**
- **IC (Spearman)** между \(\hat y_H\) и \(y_H\) (Information Coefficient)
- **Pinball loss** для q∈{0.1, 0.5, 0.9} (квантильные интервалы)

### 3.3. Направление (классификация \(d_H\))

**Метрики:**
- **AUC** (Area Under Curve)
- **Пороги**:
  - **1ч ≥ 0.58**
  - **4ч ≥ 0.60**
  - **24ч ≥ 0.62**

**Опция (для калибровки):**
- **Brier score** ≤ **0.235/0.230/0.225** (1ч/4ч/24ч)

### 3.4. Польза для решения (simple policy backtest)

**Политика:**
- Long, если \(\hat y_H > 0\), иначе — flat
- Комиссии: 6 bps/сторона (базисных пунктов)
- Слиппейдж: 4 bps

**Пороги (Sharpe net):**
- **1ч ≥ 1.0**
- **4ч ≥ 1.1**
- **24ч ≥ 1.2**

### 3.5. Release Gate v1 (для каждого горизонта)

**Условие**: выполнены **2 из 3** условий на OOS (out-of-sample):
- {MAE-gain, AUC, Sharpe}

**Минимальные пороги:**
- MAE-gain: снижение vs базы ≥ 5%/6%/8% (1ч/4ч/24ч)
- AUC: ≥ 0.58/0.60/0.62 (1ч/4ч/24ч)
- Sharpe: ≥ 1.0/1.1/1.2 (1ч/4ч/24ч)

---

## 4. Валидаторы и протокол валидации

### 4.1. Split стратегия

- **Time-based walk-forward** с **эмбарго H…5H**
- Предотвращение утечек данных из будущего

### 4.2. Окна данных

**Для 1ч/4ч:**
- Train ≈ **3 года**
- Val ≈ **6 мес**
- Test ≈ **6 мес**
- Шаг WF = **1 мес**

**Для 24ч:**
- Train ≈ **5 лет**
- Val ≈ **1 год**
- Test ≈ **1 год**
- Шаг WF = **1 квартал**

### 4.3. Leakage-guard

- **Строгие лаги**: все фичи используют только данные ≤ t
- **UTC-синхронизация**: единое время для всех источников
- **«Срез по доступности»**: для медленных источников (ETF, ончейн)
- **MA считается только по данным ≤ t**: без утечек из будущего

### 4.4. Издержки

- Комиссии/слиппейдж учитываются везде
- Внутрибараная «магия» запрещена
- Реалистичные транзакционные издержки

### 4.5. Статпроверки

- **Rolling-IC**: скользящий Information Coefficient
- **Diebold–Mariano (DM) тест**: vs бейзлайны
- **SPA-тест**: на превосходство модели
- **cFDR**: контроль ложных открытий при множественности

---

## 5. Детальный план проекта

| Недели (2025) | Фаза | Задачи | Артефакты / Acceptance |
|---------------|------|--------|------------------------|
| **30.10–03.11** | **1. Бизнес-анализ** | Цели, метрики и пороги; карта источников с T_avail; риски; SLO | Спека метрик (MD), карта источников v0, таблица рисков v1, SLO |
| **03.11–12.11** | **2. Data Understanding** | Подъём сборщиков: спот/перпы/DXY/ETF(24ч); EDA; sanity-чеки; профайлинг задержек | DVC-срез v0, EDA-ноут, отчёт по качеству/латентности |
| **10.11–17.11** | **3. Data Prep** | Выравнивание UTC; \(\mathrm{MA}_L\) (EMA/KAMA); ядро фич (≈10); train/val/test | Dataset v1, каталог фич, data-dict |
| **17.11–01.12** | **4. Modeling v1** | Бейзлайны; линейка/бустинг; квантили; калибровка; WF-эксперименты | Отчёт экспериментов v1, лучшие гиперы |
| **28.11–04.12** | **5. Evaluation** | Бэктест (комиссии), стресс на издержки; release-gate | Evaluation report, Go/No-Go |
| **02.12–16.12** | **6. Deployment v1** | REST/gRPC; кэш/квоты; мониторинг метрик/дрейфа; алерты; CI/CD; API-доки | API v1, дашборд метрик, playbook |
| **параллельно** | **UX/Content** | Отчёт-карточка (чарты, «пузыри», объяснимость, режим рынка), локализация | UI-гайд, шаблоны карточек |

---

## 6. Бэклог данных и фич (после релиза MVP)

### 6.1. Ордербук/имбаланс (L1–L10)

- Imbalance, slope, «тонкость», ΔSpread, OFI
- Частота: сек/мин → 1m/5m
- Лаги: 1–6 баров

### 6.2. Перпетуалы

- Funding, basis, OI, дисперсия по биржам, OI/Cap, ликвидации
- Частота: минуты/часы
- Лаги: 1–48 баров

### 6.3. Опционы

- IV term-structure, skew (RR25/10), GEX, vanna/charm
- Частота: час/день
- Лаги: 6–72 ч
- Синхронизация UTC-close

### 6.4. Ончейн-агрегаты

- Netflow биржи, NUPL/MVRV, SOPR, realized cap
- Частота: день/час
- Лаги: 1–7 дней

### 6.5. Стейблкоины

- Free-float USDT/USDC, биржевые балансы
- Частота: день/час
- Лаги: 1–7 дней

### 6.6. ETF-потоки

- Притоки/оттоки, AUM
- Частота: день
- Лаги: 1–3 дня

### 6.7. Макро/кросс-рынки

- DXY, UST 2y/10y, S&P 500, VIX, золото и т.д.
- Частота: день/час
- Лаги: 1–10 дней

### 6.8. Сентимент/поиск

- Google Trends, новости/тональность, соц-сигналы
- Частота: часы/дни
- Лаги: 1–7 дней

### 6.9. Мемпул/сеть

- Комиссии, заполненность блоков, всплески инскрипций
- Частота: мин/час
- Лаги: 1–48 ч

### 6.10. Тех-признаки

- KAMA, Donchian, сглаженный ADX, Chande K/ROC, режимы RSI
- \(z\)-скоры волатильности/объёма
- Разрежённые лаги

### 6.11. Денежная масса (M2/M3) — гипотеза лага

- Лаг: 30–120 дней
- Проверка: CCF, rolling-IC, OOS-тесты
- Использование: для 24ч/режимного контекста

---

## 7. Команда проекта

### 7.1. Роли и обязанности

- **Менеджер проекта**: Координация, управление сроками и ресурсами
- **Data Scientist / ML Engineer**: Разработка и обучение моделей
- **Backend Developer**: Разработка API и интеграций
- **Data Engineer**: Подготовка и управление данными
- **QA Engineer**: Тестирование системы

### 7.2. Текущая команда

- **Разработчик**: Выполняет роли Data Scientist, Backend Developer, Data Engineer
- **Консультант/Эксперт**: Может быть привлечен для консультаций по ML

### 7.3. Необходимые компетенции

- ✅ Python программирование
- ✅ Машинное обучение (базовый уровень)
- ✅ Работа с API и базами данных
- ✅ Асинхронное программирование
- ⚠️ Продвинутое машинное обучение (может потребоваться консультация)
- ⚠️ DevOps (может потребоваться для production развертывания)

---

## 8. Ожидаемые результаты

### 8.1. Основные результаты

- **ML модель**: Модель для прогнозирования отклонения от MA с выполнением Release Gate
- **Telegram Bot**: Работающий бот с интеграцией ML прогнозов
- **Документация**: Полная документация проекта, включая описание модели и API
- **Мониторинг**: Система мониторинга качества прогнозов и работы бота

### 8.2. Дополнительные результаты

- **Аналитика**: Визуализация данных и прогнозов (отклонение от MA, направление движения)
- **История прогнозов**: Сохранение прогнозов для последующего анализа и обучения
- **Расширяемость**: Архитектура, позволяющая легко добавлять новые модели и функции

### 8.3. Критерии успеха проекта

- ✅ Модель выполняет Release Gate (2 из 3 условий: MAE-gain, AUC, Sharpe)
- ✅ Бот работает стабильно (uptime ≥ 99%, SLO выполнены)
- ✅ Пользователи получают понятные прогнозы (отклонение от MA и направление)
- ✅ Документация полная и актуальная
- ✅ Система готова к масштабированию

---

## 9. Заключение

Проект AI Индикатор рынка BTC направлен на решение реальной бизнес-проблемы - предоставление пользователям прогнозов отклонения цены Bitcoin от скользящего среднего на основе машинного обучения.

### 9.1. Ключевые особенности проекта

**Подход к моделированию:**
- Фокус на прогнозировании **логарифмического отклонения от скользящего среднего** (MA)
- Более стабильный и математически обоснованный подход
- Естественный бейзлайн (MA) отражает тренд рынка
- Уменьшает влияние долгосрочных трендов и фокусируется на краткосрочных движениях

**Метрики:**
- Сфокусированный набор ключевых метрик (MAE, AUC, Sharpe)
- Конкретные пороги для каждого горизонта (1ч/4ч/24ч)
- Release Gate: выполнение 2 из 3 условий для релиза
- Бейзлайны для сравнения (Persistence, Seasonality, Rule-based)

**Цели:**
- Прогнозирование отклонения от MA на горизонтах 1ч, 4ч, 24ч
- Классификация направления движения (выше/ниже MA)
- Интеграция с Telegram Bot для удобного доступа пользователей
- Объяснимые отчёты с ключевыми метриками и визуализациями

### 9.2. Преимущества проекта

- ✅ Решает реальную проблему пользователей (краткосрочные прогнозы движения BTC)
- ✅ Использует стабильный и математически обоснованный подход (логарифмическое отклонение от MA)
- ✅ Имеет четкие и конкретные критерии успеха (Release Gate)
- ✅ Опирается на доступные данные и ресурсы
- ✅ Имеет план митигации рисков
- ✅ Сфокусированные метрики для лучшей оценки качества



