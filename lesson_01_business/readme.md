# AI Индикатор рынка BTC — Бизнес-анализ (MVP)

## 1. Цели и формулировка задачи

### 1.1. Цель проекта
Построить **AI-индикатор** для прогноза движения **Bitcoin** на горизонтах **1ч, 4ч, 24ч** и формирования **объяснимого отчёта** в Telegram с ключевыми метриками и визуализациями.

### 1.2. Проблема
Розничным трейдерам и аналитикам не хватает объяснимого и оперативного прогноза BTC «на ближайшие часы» в удобном формате Telegram-бота.

### 1.3. Ценность
**Для пользователя:**
- Консистентные прогнозы на 1ч/4ч/24ч.
- Единый отчёт-карточка с ключевыми метриками (волатильность, позиционирование, уровни риска/тренда).
- Доступ к использованным признакам (feature dump) и графикам.
- Объяснимые прогнозы **отклонения от тренда**.

**Для команды:**
- Учебная витрина MLOps и чистой архитектуры.
- Площадка для исследований и расширений (альткоины, другие рынки, новые источники данных).
- Отработка практик разработки ML-сервисов.

### 1.4. Бизнес-цель
Дать воспроизводимый и объяснимый **прогноз по BTC/USDT** на горизонтах **1ч, 4ч, 24ч**, дополняя его отчётом по факторам риска и режиму рынка, чтобы повысить полезность бота и подготовить монетизацию (подписка).

### 1.5. ML-формулировка (две связанные подзадачи)

**1) Регрессия «отклонения от тренда» (residual):**
$$
y_H(t)=\log P_{t+H}-\log \mathrm{MA}_L(t)
$$
где $\mathrm{MA}_L$ — EMA/KAMA, рассчитанная **строго до $t$** (без утечек).

**2) Классификация направления:**
$$
d_H(t)=\mathbb{1}\!\left[y_H(t)>0\right]
$$

**Вывод для каждого горизонта $H$:**
- Точечный прогноз $\hat y_H$, квантильные интервалы (0.1/0.5/0.9) и вероятность направления $\hat p=P(y_H>0)$.
- «Режим рынка» (волатильность/тренд/ликвидность) для контекста решения.

**Обоснование подхода:**
- Лог-отклонение от MA стабилизирует таргет и снижает нестационарность.
- MA — естественный бейзлайн, отражающий тренд.
- Фокус на краткосрочных дисбалансах вокруг тренда улучшает интерпретацию.

---

## 2. Текущая ситуация (целевой контур MVP)

### 2.1. Технический контур
**Компоненты:** API (FastAPI), Telegram-worker (python-telegram-bot), сборщики данных, headless-визуализация (matplotlib).  
**Хранилище:** SQLite (WAL); слои: «сырые данные» → «фичи/лейблы» → «метрики/отчёты».  
**Интеграции (MVP):** спот/перпы (биржи/агрегаторы), DXY; опционально — ETF-потоки для 24ч.  
**Функции отчёта:** прогнозы 1ч/4ч/24ч, режим рынка, уровни/моментум, «пузыри», топ-движения, дайджест.

### 2.2. Данные и целевые переменные
**Источники:** OHLCV BTCUSDT (вспомогательно: ETH, TOTAL2/3, BTC.D, USDT.D), перпетуалы (funding, basis, OI, ликвидации), DXY; для 24ч — дневные ETF-потоки (если доступны).

**Фичи (ядро MVP, ~10):**
1. $z$-score цены к $\mathrm{MA}_L$.
2. Realized vol $\sigma_{20}$ (на целевом ТФ).
3. ATR% (14).
4. RSI(14) (+ бинарный «RSI > 50»).
5. Нормированный моментум (MACD-hist/ATR).
6. Funding z-score; Basis z-score.
7. $\Delta\mathrm{OI}\%$, нормированная на объём.
8. Интенсивность ликвидаций (окно 6–24ч), нормированная.
9. Для 24ч — DXY $\Delta 1d$ **или** ETF net-flow ($t-1$).
10. Исторические отклонения от MA (лаги 1–6).

**Таргеты:** регрессия $y_H(t)$ (residual), классификация $d_H(t)$.

### 2.3. Ресурсы и доступы
Контейнеры Docker на CPU; API-ключи провайдеров; TZ/квоты в `.env`; ретраи, backoff, circuit-breaker, кэш.

### 2.4. Ограничения/правовые аспекты
Нестационарность (data drift); Telegram rate limits; дисклеймеры (не персональные рекомендации); безопасное хранение секретов/логов.

### 2.5. Риски и меры снижения
| Риск | Проявление | Влияние | Митигирующие меры |
|---|---|---:|---|
| Non-stationarity | Падение качества онлайн | Высокое | Walk-forward/rolling, регулярное переобучение, мониторинг дрейфа, режимные гейты |
| Look-ahead утечки | Завышенные offline-метрики | Высокое | Purged/embargoed CV, строгие лаги, «срез по доступности», MA только по данным $\le t$ |
| Пропуски/качество | Разрывы/аномалии | Среднее | Импутации, фильтры качества, резервные провайдеры, sanity-чекеры |
| Латентность `T_avail` | Запоздание ломает отчёты | Среднее | Карта источников с p50/p90-лагами, деградация до без-фичевого режима |
| API-квоты/изменения | Ошибки сборки/инференса | Среднее | Адаптеры, circuit-breaker, кэш/пуллинг, алерты |
| Ожидания пользователей | Негатив/отток | Среднее | Ясные метрики и «правила игры», калибровка вероятностей |
| Комплаенс | Претензии к контенту | Среднее | Дисклеймеры, секреты в vault, аудит логов |

### 2.6. Операционные SLO
Доступность ≥ **99%** закрытых баров; свежесть ≤ **30 с** (1ч/4ч), ≤ **2 мин** (24ч); p95 инференса ≤ **2 с**; p95 доставки ≤ **5 с**; ≤ **1%** 4xx/5xx/timeout в сутки; в отчёте — версия модели, хэш данных/фич, timestamp.

### 2.7. Карта источников и задержек доступности (черновик v0)
| Источник | Сигналы | Частота | Типичный `T_avail` | SLA/примечание |
|---|---|---|---|---|
| Биржи (spot/perp) | OHLCV, OI, funding | мин/час | секунды–минуты | Основной фид; **только финальные бары**; фолбэк — агрегатор |
| Опционы (агрегатор) | — (MVP без опционов) | — | — | опционный блок — backlog v2 |
| CoinGlass/аналоги | Ликвидации, OI-сводки | мин/час | 1–10 мин | квоты / rate-limit |
| Ончейн-агрегатор | — (MVP без ончейна) | — | — | ончейн — backlog v2 |
| ETF-потоки | Притоки/оттоки, AUM | день | 12–36 ч | использовать только для 24ч |
| Макро (DXY) | Индекс доллара | 1ч/1д | 15–60 мин | события (CPI/FOMC) флажить |

---

## 3. Метрики оценки и критерии успешности (сфокусированные)

### 3.1. Бейзлайны (обязательно)
1) **Persistence:** $\hat y_H=0$, $\hat p=0.5$.  
2) **Seasonality:** частотная модель «час-в-неделе».  
3) **Rule-based:** знак EMA-кросса/последней доходности.

### 3.2. Регрессия (таргет $y_H$)
**Метрика:** **MAE($y_H$)** в б.п. (база — нулевой прогноз).  
**Порог успеха (MAE-gain):** **1ч ≥ 5%**, **4ч ≥ 6%**, **24ч ≥ 8%**.  
**Диагностика:** **IC (Spearman)**; **Pinball loss** для $q\in\{0.1,0.5,0.9\}$.

### 3.3. Направление (классификация $d_H$)
**Метрика:** **AUC** — **1ч ≥ 0.58**, **4ч ≥ 0.60**, **24ч ≥ 0.62**.  
**Опция:** **Brier score** ≤ **0.235/0.230/0.225** (1ч/4ч/24ч).

### 3.4. Польза для решения (simple policy backtest)
**Политика:** long, если $\hat y_H>0$, иначе — flat. Комиссии **6 bps/сторона**, слиппейдж **4 bps**.  
**Порог:** **Sharpe (net)** ≥ **1.0/1.1/1.2** (1ч/4ч/24ч).

### 3.5. Release Gate v1 и No-Go
Релиз по горизонту, если выполнены **2 из 3**: {MAE-gain, AUC, Sharpe} на OOS.  
**No-Go:** если не выполнены 2/3 — переносим релиз, дорабатываем фичи/калибровку/режимный гейт.

---

## 4. Валидаторы и протокол валидации

### 4.1. Split-стратегия
Time-based **walk-forward** с **эмбарго $H…5H$**.

### 4.2. Окна данных
**1ч/4ч:** train ≈ **3 года**, val ≈ **6 мес**, test ≈ **6 мес**, шаг WF = **1 мес**.  
**24ч:** train ≈ **5 лет**, val ≈ **1 год**, test ≈ **1 год**, шаг WF = **1 кв.**.

### 4.3. Leakage-guard и издержки
Строгие лаги, UTC-синхронизация, «срез по доступности» для медленных источников; $\mathrm{MA}_L$ только по данным $\le t$. Комиссии/слиппейдж учитываются везде; внутрибараная «магия» запрещена.

### 4.4. Статпроверки
Rolling-IC, **Diebold–Mariano** vs бейзлайны, **SPA**-тест, **cFDR** при множественности.

---

## 5. Детальный план проекта
| Недели (2025) | Фаза | Задачи | Артефакты / Acceptance |
|---|---|---|---|
| 30.10–03.11 | 1. Бизнес-анализ | Цели/метрики/пороги; карта источников (`T_avail`); риски; SLO | Спека метрик, карта источников v0, риски v1, SLO |
| 03.11–12.11 | 2. Data Understanding | Сборщики: спот/перпы/DXY/ETF(24ч); EDA; sanity-чеки; профайлинг задержек | DVC-срез v0, EDA-ноут, отчёт по качеству/латентности |
| 10.11–17.11 | 3. Data Prep | Выравнивание UTC; $\mathrm{MA}_L$ (EMA/KAMA); ядро фич (≈10); подбор $L$ без утечек; train/val/test | Dataset v1, каталог фич, data-dict |
| 17.11–01.12 | 4. Modeling v1 | Бейзлайны; линейка/бустинг; квантили; калибровка; WF-эксперименты | Отчёт экспериментов v1, лучшие гиперы |
| 28.11–04.12 | 5. Evaluation | Бэктест (комиссии), стресс издержек; release-gate | Evaluation report, Go/No-Go |
| 02.12–16.12 | 6. Deployment v1 | REST/gRPC; кэш/квоты; мониторинг метрик/дрейфа; алерты; CI/CD; API-доки | API v1, дашборд метрик, playbook |
| параллельно | UX/Content | Отчёт-карточка (чарты, «пузыри», объяснимость, режим), локализация | UI-гайд, шаблоны карточек |

---

## 6. Бэклог данных и фич (после релиза MVP)
- **Ордербук/имбаланс (L1–L10)** — imbalance, slope, «тонкость», $\Delta$Spread, OFI; сек/мин → 1m/5m; лаги 1–6 баров.  
- **Перпетуалы** — funding, basis, OI, дисперсия по биржам, OI/Cap, ликвидации; минуты/часы; лаги 1–48 баров.  
- **Опционы** — IV term-structure, skew (RR25/10), GEX, vanna/charm; час/день; лаги 6–72 ч.  
- **Ончейн-агрегаты** — netflow, NUPL/MVRV, SOPR, realized cap; день/час; лаги 1–7 дней.  
- **Стейблкоины** — free-float USDT/USDC, биржевые балансы; день/час; лаги 1–7 дней.  
- **ETF-потоки** — притоки/оттоки, AUM; день; лаги 1–3 дня.  
- **Макро/кросс-рынки** — DXY, UST 2y/10y, S&P 500, VIX, золото; день/час; лаги 1–10 дней.  
- **Сентимент/поиск** — Google Trends, новости/тональность, соц-сигналы; часы/дни; лаги 1–7 дней.  
- **Мемпул/сеть** — комиссии, заполненность блоков, всплески инскрипций; мин/час; лаги 1–48 ч.  
- **Тех-признаки** — KAMA, Donchian, сглаженный ADX, Chande K/ROC, режимы RSI, $z$-скоры волатильности/объёма, разрежённые лаги.



