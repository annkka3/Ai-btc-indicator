# AI Индикатор рынка BTC — Бизнес-анализ (ревизия)

## 1) Цели и формулировка задачи

**Цель проекта** — построить **AI‑индикатор рынка**, который прогнозирует движение цены **Bitcoin** на горизонтах **1ч, 4ч и 24ч**, а также формирует **подробный отчёт** в Telegram с объясняющими метриками и визуализациями.

**Проблема.** Розничным трейдерам и аналитикам не хватает объяснимого и оперативного прогноза цены BTC «на ближайшие часы», интегрированного в удобный формат — Telegram‑бота.

**Ценность.**
- Для пользователя: консистентные прогнозы на 1ч/4ч/24ч, единый карточный отчёт с ключевыми метриками (волатильность, позиционирование, опционные уровни, риск‑режим), доступ к используемым признакам (feature dump) и графикам.
- Для команды: учебная витрина MLOps и чистой архитектуры, площадка для исследований и расширений (альткоины, другие рынки, новые источники данных).

**Бизнес‑цель.** Дать пользователю воспроизводимый и объяснимый **прогноз по BTC/USDT** на горизонтах **1ч, 4ч, 24ч**, дополнить прогноз отчётом по факторам риска и режиму рынка. Повысить прикладную ценность бота для розничных трейдеров криптоактивов за счёт *качественных кратко‑ и среднесрочных прогнозов движения рынка* и удобной аналитики, что должно привести к росту удержания и дальнейшей монетизации бота за счёт платной подписки.

**ML‑цели (две связанные подзадачи):**
1. **Регрессия цены**: прогноз лог‑доходности \( r_{t→t+H} = \log(P_{t+H}/P_t) \) для H∈{1h,4h,24h}.
2. **Классификация направления**: вероятность роста \( \hat p = P(r>0) \) на тех же горизонтах.

**Вывод модели.** Для каждого H:
- точечный прогноз \( \hat r \), квантильные интервалы (0.1/0.5/0.9) и \( \hat p \);
- «режим рынка» (волатильность/тренд/ликвидность) для контекста решения.

---

## 2) Текущая ситуация

### 2.1. Технический ландшафт (as‑is)
- **Компоненты:** FastAPI (webhook + health), Telegram‑worker (python‑telegram‑bot), опциональный collector, визуализация (Matplotlib headless).
- **Хранилище:** SQLite (WAL), таблицы `bars`, `subs`, `user_settings`, `divs`, `events`.
- **Интеграции:** Binance/Bybit/CoinGlass/Deribit/CoinGecko/CMC/BlockchainCenter.
- **Функции:** ML‑прогноз цены, отчёты рынка, «пузыри» (1h/24h), тикер/топ/флоп/тренды, опционы BTC/ETH, уровни/дивергенции.

### 2.2. Данные и целевые переменные
- **Источники OHLCV:** TradingView/биржи; метрики BTC, ETH, TOTAL2/3, BTC.D, USDT.D, ETHBTC и др.
- **Фичи (пример):** технические индикаторы (RSI/EMA/ATR/вола), рыночные факторы (funding, basis, ликвидации), ончейн/сентимент (при наличии), календарные признаки (день недели/сезонность).
- **Таргеты:** классификация направления \(y \in \{\text{up},\, \text{down}\}\) в горизонтах 1h/4h/24h; регрессия ретёрна \(r_t\) вспомогательно.

### 2.3. Ресурсы и доступы
- **Вычисления:** CPU‑инстанс/контейнеры Docker; опционально GPU для моделей GBM/NN (не обязательно).
- **Доступы:** API‑ключи сторонних сервисов, лимиты запросов, `.env` с секретами; конфигурация TZ.
- **Надёжность:** ретраи, бэкофф, бюджетные гварды (лимиты CoinGecko/CoinGlass и пр.).

### 2.4. Ограничения/правовые аспекты
- Нестабильность крипторынка и сдвиги распределений (data drift).
- Telegram rate limits; допустимая частота рассылок.
- Финансовые дисклеймеры; запрет на персональные рекомендации; хранение токенов/логов.

### 2.5. Риски и меры снижения

| Риск | Проявление | Влияние | Митигирующие меры |
|---|---|---:|---|
| Non‑stationarity (смена режимов) | Падение качества на онлайне | Высокое | Walk‑forward/rolling, регулярное переобучение, мониторинг дрейфа, ансамбли/регим‑гейты |
| Утечки/«смотр в будущее» | Завышенные offline‑метрики | Высокое | Purged/embargoed CV, правильные лаги, сдвиги фичей, запрет опережающих признаков |
| Пропуски/качество данных | Разрывы свечей/аномалии | Среднее | Импутация, фильтры качества, резервные провайдеры, sanity‑чекеры |
| Латентность и доступность источников (**T_avail**) | Запоздалые/редкие данные ломают отчёты | Среднее | Карта источников с T_avail, ленивые фичи для 24h, деградация до без‑фичевого режима |
| API‑квоты и изменения схем | Ошибки сборки/инференса | Среднее | Адаптеры провайдеров, circuit‑breaker, кэш/пуллинг, алерты |
| Завышенные ожидания пользователей | Негатив/отток | Среднее | Чёткие метрики и «правила игры», калибровка вероятностей, примеры использования |
| Правовые/комплаенс | Претензии к контенту | Среднее | Дисклеймеры, модерация, хранение секретов в vault, аудит логов |

### 2.6. Операционные SLO (для сервиса)
- **Доступность прогнозов:** ≥ **99%** закрытых баров сопровождаются отчётом.
- **Свежесть:** прогноз готов ≤ **30 с** после close (1h/4h), ≤ **2 мин** (24h).
- **Латентность:** p95 генерации ≤ **2 с**; p95 доставки в Telegram ≤ **5 с** после close.
- **Надёжность интеграций:** ≤ **1%** 4xx/5xx/timeout в сутки; авторетраи и exponential backoff включены.
- **Версионирование:** в каждом отчёте — версия модели, хэш данных/фичей, timestamp генерации.

### 2.7. Карта источников и задержек доступности (**черновик v0**)

| Источник | Сигналы | Частота | Типичный **T_avail** | SLA/примечание |
|---|---|---|---|---|
| Binance/Bybit (spot/perp) | OHLCV, OI, funding | мин/час | секунды–минуты | основной фид; фолбэк: TV/CCXT кэш |
| Deribit | IV‑кривая, skew, GEX | час/день | 5–30 мин | синхронизация по UTC‑close |
| CoinGlass | Ликвидации, OI‑сводки | мин/час | 1–10 мин | квоты и rate‑limit |
| Glassnode/около | Ончейн‑агрегаты | день/час | часы–дни | отчётные лаги, используем для 24h |
| ETF‑потоки (спот BTC‑ETF) | Притоки/оттоки, AUM | день | 1–3 дня | отчётная задержка |
| Макро/DXY/индексы | Кросс‑рынки | день/час | 0–1 день | события (CPI/FOMC/NFP) флажим |
| Сентимент/поиск | News/Trends | час/день | 1–3 дня | сглаживания против шума |

---

## 3) Метрики оценки и критерии успешности

Оцениваем **раздельно**: регрессию и направление, калибровку вероятностей, качество интервалов и **пользу для решения** (бэктест‑метрики). Сравнение — против бейзлайнов: **Persistence (нулевая доходность)**, **Seasonality (час‑в‑неделе)**, **простые правила (RSI/EMA‑кроссы)**.

### 0. Бейзлайны (обязательные)
1) **Persistence/Naive‑RW**: \(\hat r=0\), \(\hat p=0.5\).  
2) **Seasonality**: медиана/частота по «час‑в‑неделе».  
3) **Rules**: знак EMA‑кросса / последней доходности.

### 3.1. Регрессия \(r_{t→t+H}\)
**Метрики:**
- **MAE (б.п.)** — базовая ошибка; 
- **MASE** = MAE/MAE\(_{persistence}\) — «переплюнули ли persistence»;
- **IC (Spearman)** между \(\hat r\) и \(r\) — сила упорядочивания;
- **Pinball loss** для q∈{0.1,0.5,0.9};
- **CRPS** — строгая вероятностная метрика всей дистрибуции.

**Интервалы:**
- **PICP (coverage 80%)** целевой **76–84%**; 
- **MPIW** — ширина интервала (не «жульничать» узкими интервалами).

### 3.2. Направление (классификация up/down)
**Первичные:** **Brier score**, **Log‑loss**, **ECE** (калибровка), наклон/сдвиг reliability curve.  
**Вторичные:** **Balanced Accuracy**, **AUC** — для диагностики и отчётности.

### 3.3. Польза для решения (simple policy backtest)
**Политика:** лонг, если \(\hat p>\tau_{up}\); шорт, если \(\hat p<\tau_{dn}\); иначе — кэш. Комиссии+слиппейдж — **10 б.п. round‑trip** минимум. Ребаланс не чаще H.  
**Метрики:** **Net return**, **Sharpe**, **Sortino**, **MaxDD**, **Calmar**, **Turnover**, **Hit‑rate**, **Avg trade**.  
**Устойчивость:** повтор с удвоенными комиссиями и +50% слиппейджа — **Sharpe остаётся > 0** на целевых горизонтах.

### 3.4. Пороговые критерии успеха (фиксируются на OOS ≥ 3 мес; для 24h — ≥ 6 мес)

**Уровень A — MVI (минимально жизнеспособный индикатор)**
- **Регрессия:** **MASE < 1.00** (4h/24h), **≤ 1.05** (1h); **IC ≥ 0.05/0.06/0.07** (1h/4h/24h); **CRPS** лучше persistence ≥ **5%**; **PICP 80%** в **76–84%**.
- **Направление:** **Brier** лучше climatology ≥ **5%**, **ECE ≤ 0.06**; AUC ≥ **0.58/0.60/0.62** (1h/4h/24h).
- **PNL:** **Sharpe ≥ 0.3/0.2/0.1** (24h/4h/1h) после 10 б.п. RT; **DM‑тест p < 0.10** против Persistence ≥ на одном H.
- **SLO:** доступность ≥ **98%**, свежесть ≥ **95%** дедлайнов.

**Уровень B — ALPHA (готово для пользователей)**
- **Регрессия:** **MASE ≤ 0.95** (4h/24h), **≤ 0.98** (1h); **IC ≥ 0.07/0.08/0.10**; **CRPS** лучше ≥ **10%**.
- **Направление:** **Brier** лучше ≥ **10%**, **Log‑loss** лучше ≥ **6%**; **ECE ≤ 0.05**, наклон 0.9–1.1; **BalAcc** ≥ **0.54/0.55/0.56**.
- **PNL:** **Sharpe ≥ 0.9/0.6/0.35** (24h/4h/1h); **MaxDD** ≤ 20% годовой σ‑PnL; при удвоенных комиссиях **Sharpe > 0**.
- **SLO:** доступность ≥ **99%**, свежесть ≥ **98%**, p95 генерации ≤ **2 с**, доставки ≤ **5 с**.

**Уровень C — PRO (сильная витрина + платная подписка)**
- **Регрессия:** **MASE ≤ 0.90** (4h/24h), **≤ 0.95** (1h); **CRPS** лучше ≥ **15%**.
- **Направление:** **Brier** лучше ≥ **15%**, **Log‑loss** лучше ≥ **8%**; **ECE ≤ 0.04**; стабильность важностей (корреляция топ‑10 фичей неделя‑к‑неделе) ≥ **0.6**.
- **PNL:** **Sharpe ≥ 0.9/0.6/0.35** (24h/4h/1h), **Calmar ≥ 0.6**, положительный PnL в каждом квартале OOS.
- **SLO:** 99.5% доступности; в отчёте — версия модели/хэш данных/время генерации.

---

## 4) Валидаторы и протокол валидации
- **Split:** time‑based, walk‑forward с **эмбарго от H до 5H**.
- **Окна:** для 1h/4h: train ≈ **3 года**, val ≈ **6 мес**, test ≈ **6 мес**, шаг WF = **1 месяц**; для 24h: train ≈ **5 лет**, val ≈ **1 год**, test ≈ **1 год**.
- **Leakage‑guard:** строгие лаги, синхронизация в UTC, «срез по доступности» для медленных источников (ETF/ончейн/макро).
- **Вектор затрат:** комиссии, проскальзывание, лимит Turnover, без внутрибараной «магии».
- **Гиперпараметры:** подбираются **только** на val‑окне каждого WF; лог экспериментов.
- **Статпроверки:** rolling‑IC, **DM‑тест (Diebold–Mariano)** vs бейзлайны, **SPA‑тест** на превосходство, **cFDR** при множественности.

---

## 5) Детальный план проекта

| Недели (2025) | Фаза | Задачи | Артефакты / Acceptance |
|---|---|---|---|
| **30.10–03.11** | **1. Бизнес‑анализ** | Финализация целей, метрик и порогов (A/B/C); карта источников с **T_avail**; риски; SLO | Спека метрик (MD), карта источников v0, таблица рисков v1, SLO утверждены |
| **03.11–12.11** | **2. Data Understanding** | Подъём пайплайнов сбора: спот/перпы/опционы/ончейн/ETF/макро/сентимент; EDA; sanity‑чеки; профайлинг задержек | DVC‑срез v0, EDA‑ноут, отчёт по качеству/латентности |
| **10.11–17.11** | **3. Data Prep** | Выравнивание и ресэмпл в UTC; лаги/агрегации; нормализация; train/val/test; фичи волна‑1 (тех+перпы+сентимент) | Dataset v1, каталог фич, data‑dic |
| **17.11–01.12** | **4. Modeling v1** | Бейзлайны (Naive/Seasonal/RSI/EMA); бустинги/линейка; квантили; калибровка; explainability; WF‑эксперименты | Отчёт экспериментов v1, лучшие гиперы |
| **28.11–04.12** | **5. Evaluation** | Бэктест с комиссиями; стресс на издержки; сравнение по режимам/гейтам; финальный отчёт | Evaluation report, Go/No‑Go |
| **02.12–16.12** | **6. Deployment v1** | REST/gRPC; кэш/квоты; мониторинг метрик/дрейфа; алерты; CI/CD; документация API | API v1, дашборд метрик, playbook |
| **параллельно** | **UX/Content** | Отчёт для пользователя (чарты, альбомы, «пузыри», объяснимость, режим рынка), локализация | UI‑гайд, шаблоны карточек отчёта |

---

## 6) Бэклог данных и фич
Категория → **сигналы**, трансформации, частота, латентность, кандидаты лагов.

**A) Ордербук/имбаланс (L1–L10)** — imbalance, slope, «тонкость»; ΔSpread; OFI. Частота: сек/мин → 1m/5m; лаги 1–6 баров.

**B) Перпетуалы** — funding, basis, OI, дисперсия OI по биржам, OI/Cap, ликвидации. Частота: минуты/часы; лаги 1–48 баров.

**C) Опционы** — IV term‑structure, skew (RR25/10), GEX, vanna/charm. Частота: час/день; лаги 6–72 ч; синхронизация UTC‑close.

**D) Ончейн‑агрегаты** — netflow на/из бирж, NUPL/MVRV, SOPR, realized cap, активные адреса, комиссии. Частота: день/час; лаги 1–7 дней.

**E) Стейблкоины** — free‑float USDT/USDC, биржевые балансы, эмиссия/погашение. Частота: день/час; лаги 1–7 дней.

**F) ETF‑потоки (спот BTC‑ETF)** — притоки/оттоки, AUM. Частота: день; лаги 1–3 дня.

**G) Макро/кросс‑рынки** — DXY, UST 2y/10y (real), S&P 500, VIX, золото, USD/JPY, USD/CNH. Частота: день/час; лаги 1–10 дней.

**H) Сентимент/поиск** — Google Trends, новостная интенсивность/тональность, соц‑сигналы. Частота: часы/дни; лаги 1–7 дней.

**I) Мемпул/сеть** — комиссии, заполненность блоков, всплески инскрипций/ордисов. Частота: мин/час; лаги 1–48 часов.

**J) Технические признаки** — KAMA, Donchian, сглаженный ADX, Chande K/ROC, RSI‑режимы, z‑скоры волы/объёма, разрежённые лаги. Частота: каждый бар; лаги 1–96 баров.

**K) Денежная масса (M2/M3) — гипотеза лага** — лаг 30–120 дней; проверка: CCF, rolling‑IC, OOS‑тест, режимы DXY/волы; использовать для 24h/режимного контекста.
